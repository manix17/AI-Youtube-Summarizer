#!/usr/bin/env node

/**
 * Script to automatically sync dom_parser.ts to dom-parser-module.js for testing
 * This ensures the test page always uses the latest version of the parser
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const sourceFile = path.join(__dirname, '../src/utils/dom_parser.ts');
const targetFile = path.join(__dirname, '../tools/dom-parser-module.js');
const tempFile = path.join(__dirname, '../temp_dom_parser.js');

function syncDomParser() {
    try {
        if (!fs.existsSync(sourceFile)) {
            console.error('‚ùå Source file not found:', sourceFile);
            return;
        }

        console.log('üîÑ Syncing dom_parser.ts to dom-parser-module.js...');

        // Use TypeScript compiler to transpile the file
        const tscCommand = `npx tsc "${sourceFile}" --target ES2020 --module ES2020 --outDir "${path.dirname(tempFile)}" --outFile "${tempFile}" --skipLibCheck --moduleResolution node`;
        
        try {
            execSync(tscCommand, { stdio: 'pipe' });
        } catch (tscError) {
            // Fallback to manual conversion if tsc fails
            console.log('‚ö†Ô∏è TypeScript compiler failed, using manual conversion...');
            return manualConversion();
        }

        // Read the compiled JavaScript
        let jsContent = '';
        if (fs.existsSync(tempFile)) {
            jsContent = fs.readFileSync(tempFile, 'utf8');
            fs.unlinkSync(tempFile); // Clean up temp file
        } else {
            // Fallback to manual conversion
            return manualConversion();
        }

        // Add header comment
        const header = `// Auto-generated JavaScript version of src/utils/dom_parser.ts
// This file is automatically synchronized with the TypeScript source
// 
// DO NOT EDIT THIS FILE DIRECTLY - it will be overwritten
// Edit src/utils/dom_parser.ts instead and run: npm run sync-parser
//
// Last updated: ${new Date().toISOString()}

`;

        const finalContent = header + jsContent;

        // Ensure tools directory exists
        const toolsDir = path.dirname(targetFile);
        if (!fs.existsSync(toolsDir)) {
            fs.mkdirSync(toolsDir, { recursive: true });
        }

        // Write the JavaScript version
        fs.writeFileSync(targetFile, finalContent, 'utf8');

        console.log('‚úÖ Successfully synced dom_parser.ts ‚Üí tools/dom-parser-module.js');
        console.log(`üìÅ Generated: ${targetFile}`);
        
    } catch (error) {
        console.error('‚ùå Error syncing dom parser:', error.message);
        process.exit(1);
    }
}

function manualConversion() {
    console.log('üîß Using manual TypeScript to JavaScript conversion...');
    
    // Read the TypeScript source
    const tsContent = fs.readFileSync(sourceFile, 'utf8');

    // More careful TypeScript to JavaScript conversion
    let jsContent = tsContent
        // Remove simple type annotations from function parameters (be more careful with regex)
        .replace(/function\s+(\w+)\s*\([^)]*\)/g, (match) => {
            // Remove type annotations from function parameters more carefully
            return match.replace(/:\s*[^,)]+/g, '');
        })
        // Remove return type annotations more carefully
        .replace(/\):\s*[^{]+\s*\{/g, ') {')
        // Remove variable type annotations
        .replace(/let\s+(\w+):\s*[^=;]+/g, 'let $1')
        .replace(/const\s+(\w+):\s*[^=;]+/g, 'const $1')
        // Remove array type annotations
        .replace(/:\s*string\[\]/g, '')
        .replace(/:\s*number\[\]/g, '')
        // Remove TypeScript non-null assertion operator
        .replace(/\.pop\(\)!/g, '.pop()')
        // Remove TypeScript 'as' type assertions
        .replace(/\s+as\s+\w+/g, '')
        // Convert ES6 imports to browser-compatible format
        .replace(/^import\s+\{\s*marked\s*\}\s+from\s+['"]marked['"];?\s*$/gm, '// Import marked from CDN - should be loaded globally')
        .replace(/^import\s+.*DOMPurify.*$/gm, '// Import DOMPurify from CDN - should be loaded globally')
        // Fix marked API usage to use marked.parse() instead of marked()
        .replace(/const rawHtml = marked\(/g, 'const rawHtml = marked.parse(')
        // Fix variable declarations with array types
        .replace(/let\s+(\w+)= \[\]/g, 'let $1 = []');

    // Add header comment
    const header = `// Auto-generated JavaScript version of src/utils/dom_parser.ts
// This file is automatically synchronized with the TypeScript source
// 
// DO NOT EDIT THIS FILE DIRECTLY - it will be overwritten
// Edit src/utils/dom_parser.ts instead and run: npm run sync-parser
//
// Last updated: ${new Date().toISOString()}

`;

    const finalContent = header + jsContent;

    // Ensure tools directory exists
    const toolsDir = path.dirname(targetFile);
    if (!fs.existsSync(toolsDir)) {
        fs.mkdirSync(toolsDir, { recursive: true });
    }

    // Write the JavaScript version
    fs.writeFileSync(targetFile, finalContent, 'utf8');

    console.log('‚úÖ Successfully synced using manual conversion');
    console.log(`üìÅ Generated: ${targetFile}`);
}

// Run the sync
syncDomParser();